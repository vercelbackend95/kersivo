---
import "./topnav.css";
import "../styles/neon-nav.css";
import CtaButton from "./CtaButton.astro";
---

<header class="k-topnav" data-topnav>
  <a class="k-skip" href="#main">Skip to content</a>

  <div class="k-topnav__inner">
    <a class="k-topnav__brand" href="/" aria-label="Kersivo home">
      <span class="k-topnav__mark" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path
            d="M12 2l1.2 5.1L18 8.3l-4.4 2.4L12 16l-1.6-5.3L6 8.3l4.8-1.2L12 2Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
          <path
            d="M19.5 13l.6 2.3 2.4.6-2.4.6-.6 2.3-.6-2.3-2.4-.6 2.4-.6.6-2.3Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
        </svg>
      </span>
      <span class="k-topnav__name">Kersivo</span>
    </a>

    <nav class="k-topnav__links" aria-label="Primary" data-nav-links>
      <span class="k-navNeon" aria-hidden="true" data-nav-neon></span>

      <a class="k-topnav__link" href="#work" data-nav-link>Work</a>
      <a class="k-topnav__link" href="#services" data-nav-link>Services</a>
      <a class="k-topnav__link" href="#process" data-nav-link>Process</a>
      <a class="k-topnav__link" href="#contact" data-nav-link>Contact</a>
    </nav>

    <div class="k-topnav__actions">
      <a class="k-topnav__mini" href="#work">View work</a>

      <CtaButton
        href="#contact"
        label="Get a quote"
        variant="primary"
        class="k-topnav__cta"
      />

      <button
        class="k-topnav__burger"
        type="button"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="kTopnavPanel"
      >
        <span class="k-topnav__burgerLine" aria-hidden="true"></span>
        <span class="k-topnav__burgerLine" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <div class="k-topnav__panel" id="kTopnavPanel" hidden>
    <div class="k-topnav__panelInner">
      <a class="k-topnav__panelLink" href="#work">Work</a>
      <a class="k-topnav__panelLink" href="#services">Services</a>
      <a class="k-topnav__panelLink" href="#process">Process</a>
      <a class="k-topnav__panelLink" href="#contact">Contact</a>

      <div class="k-topnav__panelCtas">
        <CtaButton
          href="#contact"
          label="Get a quote"
          variant="primary"
          class="k-topnav__panelPrimary"
        />
        <CtaButton
          href="#work"
          label="View work"
          variant="ghost"
          magnetic={false}
          class="k-topnav__panelGhost"
        />
      </div>
    </div>
  </div>

  <script>
    (() => {
      const root = document.querySelector("[data-topnav]");
      if (!root) return;

      const reduced =
        window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      // ===== shrink glass on scroll =====
      const setScrolled = () => root.classList.toggle("is-scrolled", window.scrollY > 6);
      setScrolled();
      window.addEventListener("scroll", setScrolled, { passive: true });

      // ===== mobile panel =====
      const btn = root.querySelector(".k-topnav__burger");
      const panel = root.querySelector("#kTopnavPanel");

      const lockScroll = (locked) => {
        document.documentElement.style.overflow = locked ? "hidden" : "";
      };

      const open = () => {
        if (!panel || !btn) return;
        panel.hidden = false;
        root.classList.add("is-open");
        btn.setAttribute("aria-expanded", "true");
        btn.setAttribute("aria-label", "Close menu");
        lockScroll(true);
      };

      const close = () => {
        if (!panel || !btn) return;
        root.classList.remove("is-open");
        btn.setAttribute("aria-expanded", "false");
        btn.setAttribute("aria-label", "Open menu");
        lockScroll(false);
        if (reduced) return (panel.hidden = true);
        setTimeout(() => (panel.hidden = true), 180);
      };

      if (btn && panel) {
        btn.addEventListener("click", () => {
          root.classList.contains("is-open") ? close() : open();
        });

        window.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && root.classList.contains("is-open")) close();
        });

        // click on overlay closes
        panel.addEventListener("click", (e) => {
          if (e.target === panel) close();
        });

        // IMPORTANT: click on any panel link closes
        panel.querySelectorAll("a[href^='#']").forEach((a) => {
          a.addEventListener("click", () => {
            if (root.classList.contains("is-open")) close();
          });
        });
      }

      // ===== neon indicator movement + scroll spy (desktop links) =====
      const wrap = root.querySelector("[data-nav-links]");
      const neon = root.querySelector("[data-nav-neon]");
      const links = Array.from(root.querySelectorAll("[data-nav-link]"));
      if (!wrap || !neon || !links.length) return;

      const map = new Map();
      links.forEach((a) => {
        const hash = (a.getAttribute("href") || "").trim();
        if (hash && hash.startsWith("#")) map.set(hash, a);
      });

      const moveNeonTo = (a) => {
        const x = Math.round(a.offsetLeft);
        const w = Math.round(a.offsetWidth);
        wrap.style.setProperty("--nx", x + "px");
        wrap.style.setProperty("--nw", w + "px");
      };

      const pulseNeon = () => {
        if (reduced) return;
        neon.classList.remove("is-pulsing");
        void neon.offsetWidth;
        neon.classList.add("is-pulsing");
        setTimeout(() => neon.classList.remove("is-pulsing"), 160);
      };

      const setActive = (hash) => {
        const a = map.get(hash);
        if (!a) return;

        links.forEach((x) => {
          x.classList.remove("is-active");
          x.removeAttribute("aria-current");
        });

        a.classList.add("is-active");
        a.setAttribute("aria-current", "page");

        moveNeonTo(a);
        pulseNeon();
      };

      const initial =
        map.has(location.hash) ? location.hash : (links[0].getAttribute("href") || "#work");
      setActive(initial);

      links.forEach((a) => {
        a.addEventListener("click", () => {
          const hash = (a.getAttribute("href") || "").trim();
          if (hash.startsWith("#")) setActive(hash);
          if (root.classList.contains("is-open")) close();
        });
      });

      let raf = 0;
      const reflow = () => {
        cancelAnimationFrame(raf);
        raf = requestAnimationFrame(() => {
          const active = links.find((x) => x.classList.contains("is-active")) || links[0];
          moveNeonTo(active);
        });
      };

      window.addEventListener("resize", reflow, { passive: true });
      if (document.fonts && document.fonts.ready) {
        document.fonts.ready.then(reflow).catch(() => {});
      }

      const sections = Array.from(map.keys())
        .map((hash) => document.querySelector(hash))
        .filter(Boolean);

      if (!sections.length) return;

      if (reduced) {
        const onScroll = () => {
          const y = window.scrollY + window.innerHeight * 0.35;
          let best = sections[0];
          for (const s of sections) if (s.offsetTop <= y) best = s;
          setActive("#" + best.id);
        };
        onScroll();
        window.addEventListener("scroll", onScroll, { passive: true });
        return;
      }

      const ratios = new Map();
      const io = new IntersectionObserver(
        (entries) => {
          entries.forEach((e) => ratios.set(e.target, e.intersectionRatio));

          let bestEl = null;
          let bestRatio = 0;
          ratios.forEach((ratio, el) => {
            if (ratio > bestRatio) {
              bestRatio = ratio;
              bestEl = el;
            }
          });

          if (bestEl && bestEl.id) setActive("#" + bestEl.id);
        },
        {
          root: null,
          rootMargin: "-35% 0px -55% 0px",
          threshold: [0, 0.12, 0.24, 0.36, 0.5, 0.7, 0.9],
        }
      );

      sections.forEach((s) => io.observe(s));
    })();
  </script>
</header>
