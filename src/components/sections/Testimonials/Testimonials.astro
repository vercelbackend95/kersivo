---
import "./testimonials.css";

type Testimonial = {
  quote: string;
  name: string;
  role: string;
  avatar?: string; // optional local/public path
};

interface Props {
  kicker?: string;
  title?: string;
  subtitle?: string;

  leftStatValue?: string;
  leftStatLabel?: string;

  rightStatValue?: string;
  rightStatLabel?: string;

  avatars?: { label: string }[];
  testimonials?: Testimonial[];
}

const {
  kicker = "REVIEWS",
  title = "What people say",
  subtitle = "Short, real words from people I’ve worked with — focused on delivery, clarity, and taste.",

  leftStatValue = "98%",
  leftStatLabel = "Customer satisfaction rate",

  rightStatValue = "+2K",
  rightStatLabel = "Happy Customers",

  avatars = [{ label: "A" }, { label: "S" }, { label: "M" }, { label: "J" }],

  testimonials = [
    {
      quote:
        "Partnering with Bartek changed everything. Clear direction, sharp taste, and delivery that actually lands.",
      name: "Sophia Martinez",
      role: "Product Designer",
    },
    {
      quote:
        "No fluff — just organised execution. Milestones were clear and the polish level was genuinely premium.",
      name: "Tom W.",
      role: "Small Business Owner (UK)",
    },
    {
      quote:
        "Detail-obsessed in the best way. Everything feels intentional, fast, and built to convert — especially on mobile.",
      name: "Aisha K.",
      role: "Founder (UK)",
    },
  ],
} = Astro.props as Props;

const uid = `k-rev-${Math.random().toString(16).slice(2)}`;
---

<section id="reviews" class="section k-reviews" data-reviews-root={uid}>
  <div class="container">
    <header class="k-reviews__head sectionTitle">
      <h6>{kicker}</h6>

      <div class="k-reviews__headRow">
        <div class="k-reviews__titles">
          <h2>{title}</h2>
          <p class="k-reviews__sub measure">{subtitle}</p>
        </div>

        <div class="k-reviews__note" aria-hidden="true">
          <span class="k-reviews__noteDot"></span>
          <span>References available on request.</span>
        </div>
      </div>
    </header>

    <div class="k-reviews__grid">
      <!-- LEFT: portrait + big stat -->
      <article class="k-reviews__card k-reviews__card--left" aria-label="Satisfaction highlight">
        <div class="k-reviews__portrait" role="img" aria-label="Studio portrait placeholder">
          <div class="k-reviews__portraitGlow" aria-hidden="true"></div>
          <div class="k-reviews__portraitGrain" aria-hidden="true"></div>
        </div>

        <div class="k-reviews__stat">
          <div class="k-reviews__statValue">{leftStatValue}</div>
          <div class="k-reviews__statLabel">{leftStatLabel}</div>
        </div>
      </article>

      <!-- RIGHT: mini stat + main quote carousel -->
      <div class="k-reviews__right">
        <article class="k-reviews__card k-reviews__card--mini" aria-label="Happy customers highlight">
          <div class="k-reviews__avatars" aria-hidden="true">
            {avatars.slice(0, 4).map((a, i) => (
              <span class="k-reviews__avatar" style={`--i:${i}`} title={a.label}>
                <span class="k-reviews__avatarInner">{a.label}</span>
              </span>
            ))}
          </div>

          <div class="k-reviews__miniStat">
            <div class="k-reviews__miniValue">{rightStatValue}</div>
            <div class="k-reviews__miniLabel">{rightStatLabel}</div>
          </div>
        </article>

        <article class="k-reviews__card k-reviews__card--main" aria-label="Testimonials">
          <div class="k-reviews__mainInner">
            <div class="k-reviews__track" data-track>
              {testimonials.map((t, idx) => (
                <div class="k-reviews__slide" data-slide tabindex={idx === 0 ? 0 : -1}>
                  <div class="k-reviews__slideInner">
                    <p class="k-reviews__quote">“{t.quote}”</p>

                    <!-- Bottom panel INSIDE the slide -->
                    <div class="k-reviews__bottomPanel" aria-label="Testimonial footer">
                      <div class="k-reviews__author">
                        {t.avatar ? (
                          <img class="k-reviews__authorImg" src={t.avatar} alt="" loading="lazy" />
                        ) : (
                          <span class="k-reviews__authorImg k-reviews__authorImg--ph" aria-hidden="true"></span>
                        )}

                        <div class="k-reviews__authorMeta">
                          <div class="k-reviews__authorName">{t.name}</div>
                          <div class="k-reviews__authorRole">{t.role}</div>
                        </div>
                      </div>

                      <div class="k-reviews__controls" aria-label="Testimonial controls">
                        <button class="k-reviews__btn" type="button" data-prev aria-label="Previous testimonial">
                          <span class="k-reviews__chev k-reviews__chev--left" aria-hidden="true"></span>
                        </button>
                        <button class="k-reviews__btn" type="button" data-next aria-label="Next testimonial">
                          <span class="k-reviews__chev k-reviews__chev--right" aria-hidden="true"></span>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>

            <div class="k-reviews__progress" aria-hidden="true">
              <span data-cur>01</span>
              <span class="k-reviews__slash">/</span>
              <span data-total>{String(testimonials.length).padStart(2, "0")}</span>
            </div>
          </div>
        </article>
      </div>
    </div>

    <p class="k-reviews__disclaimer">
      *Testimonials are from people I’ve worked with on projects, design, or delivery — not necessarily web design clients (yet).
    </p>
  </div>

  <script is:inline>
    {String.raw`
      (() => {
        const rootId = ${JSON.stringify(uid)};
        const root = document.querySelector('[data-reviews-root="'+rootId+'"]');
        if (!root) return;

        const reduced = window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches;

        const track = root.querySelector('[data-track]');
        if (!track) return;

        const slides = Array.from(track.querySelectorAll('[data-slide]'));
        const curEl = root.querySelector('[data-cur]');
        const totalEl = root.querySelector('[data-total]');

        const mod = (n, m) => ((n % m) + m) % m;

        let index = 0;

        if (totalEl) totalEl.textContent = String(slides.length).padStart(2, '0');

        const syncUI = () => {
          slides.forEach((s, i) => (s.tabIndex = i === index ? 0 : -1));
          if (curEl) curEl.textContent = String(index + 1).padStart(2, '0');
        };

        const go = (next) => {
          if (!slides.length) return;
          index = mod(next, slides.length);

          slides[index].scrollIntoView({
            behavior: reduced ? 'auto' : 'smooth',
            block: 'nearest',
            inline: 'start',
          });

          syncUI();
        };

        // Strzałki (delegacja – przyciski są w każdej karcie)
        root.addEventListener('click', (e) => {
          const el = e.target instanceof Element ? e.target : null;
          if (!el) return;

          const prev = el.closest('[data-prev]');
          const next = el.closest('[data-next]');
          if (!prev && !next) return;

          e.preventDefault();
          go(index + (next ? 1 : -1));
        });

        // Klawiatura
        root.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowLeft') go(index - 1);
          if (e.key === 'ArrowRight') go(index + 1);
        });

        // Swipe/touchpad: licznik ma nadążać za scroll
        let raf = 0;
        const updateFromScroll = () => {
          raf = 0;
          if (!slides.length) return;

          const x = track.scrollLeft;

          let best = 0;
          let bestDist = Infinity;
          for (let i = 0; i < slides.length; i++) {
            const d = Math.abs(slides[i].offsetLeft - x);
            if (d < bestDist) { bestDist = d; best = i; }
          }

          if (best !== index) {
            index = best;
            syncUI();
          }
        };

        track.addEventListener('scroll', () => {
          if (raf) return;
          raf = requestAnimationFrame(updateFromScroll);
        }, { passive: true });

        // init
        syncUI();
      })();
    `}
  </script>
</section>
