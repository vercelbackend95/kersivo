---
// src/components/shell/TopNav/TopNav.astro
import "./topnav.css";
import "./neon-nav.css";
import CtaButton from "../../ui/CtaButton/CtaButton.astro";
---

<header class="k-topnav" data-topnav>
  <a class="k-skip" href="#main">Skip to content</a>

  <div class="k-topnav__inner">
    <a class="k-topnav__brand" href="/" aria-label="Kersivo home">
      <span class="k-topnav__mark" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
          <path
            d="M12 2l1.2 5.1L18 8.3l-4.4 2.4L12 16l-1.6-5.3L6 8.3l4.8-1.2L12 2Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
          <path
            d="M19.5 13l.6 2.3 2.4.6-2.4.6-.6 2.3-.6-2.3-2.4-.6 2.4-.6.6-2.3Z"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linejoin="round"
          />
        </svg>
      </span>
      <span class="k-topnav__name">Kersivo</span>
    </a>

    <nav class="k-topnav__links" aria-label="Primary" data-nav-links>
      <span class="k-navNeon" aria-hidden="true" data-nav-neon></span>

      <a class="k-topnav__link" href="/" data-nav-link>Home</a>
      <a class="k-topnav__link" href="/work/" data-nav-link>Work</a>
      <a class="k-topnav__link" href="/services/" data-nav-link>Services</a>
      <a class="k-topnav__link" href="/process/" data-nav-link>Process</a>
      <a class="k-topnav__link" href="/packages/" data-nav-link>Packages</a>
      <a class="k-topnav__link" href="/contact/" data-nav-link>Contact</a>
    </nav>

    <div class="k-topnav__actions">
      <a class="k-topnav__mini" href="/work/">View work</a>

      <CtaButton
        href="/contact/#contact"
        label="Get a quote"
        variant="primary"
        class="k-topnav__cta"
      />

      <button
        class="k-topnav__burger"
        type="button"
        aria-label="Open menu"
        aria-expanded="false"
        aria-controls="kTopnavPanel"
      >
        <span class="k-topnav__burgerLine" aria-hidden="true"></span>
        <span class="k-topnav__burgerLine" aria-hidden="true"></span>
      </button>
    </div>
  </div>

  <div class="k-topnav__panel" id="kTopnavPanel" hidden>
    <div class="k-topnav__panelInner">
      <a class="k-topnav__panelLink" href="/">Home</a>
      <a class="k-topnav__panelLink" href="/work/">Work</a>
      <a class="k-topnav__panelLink" href="/services/">Services</a>
      <a class="k-topnav__panelLink" href="/process/">Process</a>
      <a class="k-topnav__panelLink" href="/packages/">Packages</a>
      <a class="k-topnav__panelLink" href="/contact/">Contact</a>

      <div class="k-topnav__panelCtas">
        <CtaButton
          href="/contact/#contact"
          label="Get a quote"
          variant="primary"
          class="k-topnav__panelPrimary"
        />
        <CtaButton
          href="/work/"
          label="View work"
          variant="ghost"
          magnetic={false}
          class="k-topnav__panelGhost"
        />
      </div>
    </div>
  </div>

  <script>
    (() => {
      const root = document.querySelector("[data-topnav]");
      if (!root) return;

      const reduced =
        window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

      const burger = root.querySelector(".k-topnav__burger");
      const panel = root.querySelector("#kTopnavPanel");
      const linksWrap = root.querySelector("[data-nav-links]");
      const neon = root.querySelector("[data-nav-neon]");
      const navLinks = Array.from(root.querySelectorAll("[data-nav-link]"));

      // Scroll state
      const onScroll = () => {
        if (window.scrollY > 6) root.classList.add("is-scrolled");
        else root.classList.remove("is-scrolled");
      };
      onScroll();
      window.addEventListener("scroll", onScroll, { passive: true });

      // Mobile panel toggle
      const open = () => {
        if (!burger || !panel) return;
        burger.setAttribute("aria-expanded", "true");
        panel.hidden = false;
        panel.classList.add("is-open");
        document.documentElement.classList.add("k-navOpen");
      };

      const close = () => {
        if (!burger || !panel) return;
        burger.setAttribute("aria-expanded", "false");
        panel.classList.remove("is-open");
        document.documentElement.classList.remove("k-navOpen");
        setTimeout(() => (panel.hidden = true), 140);
      };

      burger?.addEventListener("click", () => {
        const isOpen = burger.getAttribute("aria-expanded") === "true";
        isOpen ? close() : open();
      });

      panel?.addEventListener("click", (e) => {
        const a = e.target && e.target.closest ? e.target.closest("a") : null;
        if (a) close();
      });

      window.addEventListener("keydown", (e) => {
        if (e.key === "Escape") close();
      });

      // Neon pill highlight (route-based)
      const moveNeonTo = (el) => {
        if (!neon || !linksWrap || !el) return;
        const wrapRect = linksWrap.getBoundingClientRect();
        const r = el.getBoundingClientRect();
        const left = r.left - wrapRect.left;
        neon.style.transform = `translate3d(${left}px,0,0)`;
        neon.style.width = `${r.width}px`;
        neon.style.opacity = "1";
      };

      const currentPath = (location.pathname || "/").replace(/\/+$/, "") || "/";
      const best = navLinks.find((a) => {
        const href = (a.getAttribute("href") || "").split("#")[0].replace(/\/+$/, "") || "/";
        return href === currentPath;
      });

      if (best) moveNeonTo(best);

      navLinks.forEach((a) => {
        a.addEventListener("mouseenter", () => {
          if (reduced) return;
          moveNeonTo(a);
        });
        a.addEventListener("focus", () => moveNeonTo(a));
      });

      linksWrap?.addEventListener("mouseleave", () => {
        if (best) moveNeonTo(best);
      });
    })();
  </script>
</header>
