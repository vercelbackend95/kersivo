---
import "../styles/global.css";

import SiteBg from "../components/shell/SiteBg/SiteBg.astro";
import TopNav from "../components/shell/TopNav/TopNav.astro";

const SITE_URL = "https://kersivo.co.uk";
const OG_IMAGE = `${SITE_URL}/og/kersivo-og.jpg`;

// canonical dla każdej strony
const pathname = Astro.url.pathname.endsWith("/") ? Astro.url.pathname : `${Astro.url.pathname}/`;
const PAGE_URL = `${SITE_URL}${pathname}`;

interface Props {
  title?: string;
  description?: string;
}

const {
  title = "Kersivo — Web Design & Development",
  description = "Premium, performance-first websites for UK small businesses. Astro-first builds, SEO-ready, subtle high-end motion.",
} = Astro.props as Props;
---

<!doctype html>
<html lang="en-GB">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />

    <title>{title}</title>
    <meta name="description" content={description} />

    <link rel="canonical" href={PAGE_URL} />

    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <link rel="alternate icon" href="/favicon.ico" sizes="any" />
    <link rel="apple-touch-icon" href="/apple-touch-icon.png" />

    <meta property="og:site_name" content="Kersivo" />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={PAGE_URL} />
    <meta property="og:title" content="Kersivo — Web Design & Development" />
    <meta
      property="og:description"
      content="Premium design, ruthless performance, and clear messaging — built for UK small businesses."
    />
    <meta property="og:image" content={OG_IMAGE} />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />

    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Kersivo — Web Design & Development" />
    <meta
      name="twitter:description"
      content="Premium, performance-first websites for UK small businesses. Astro-first builds, SEO-ready, subtle high-end motion."
    />
    <meta name="twitter:image" content={OG_IMAGE} />

    <meta name="robots" content="index,follow,max-image-preview:large" />

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json">
      {JSON.stringify({
        "@context": "https://schema.org",
        "@graph": [
          {
            "@type": "Organization",
            name: "Kersivo",
            url: SITE_URL,
            logo: `${SITE_URL}/favicon.svg`,
            sameAs: [],
          },
          {
            "@type": "WebSite",
            name: "Kersivo",
            url: SITE_URL,
            potentialAction: {
              "@type": "SearchAction",
              target: `${SITE_URL}/?q={search_term_string}`,
              "query-input": "required name=search_term_string",
            },
          },
          {
            "@type": "Service",
            name: "Web Design & Development",
            provider: { "@type": "Organization", name: "Kersivo" },
            areaServed: "GB",
            serviceType: "Web design, development, performance and SEO foundations",
          },
        ],
      })}
    </script>
  </head>

  <body>
    <SiteBg />

    <div id="top" class="k-shell site-foreground">
      <TopNav />
      <main id="main">
        <slot />
      </main>
    </div>

    <!-- Always start at top (prevents Safari restoring scroll into sections) -->
    <script>
      (() => {
        const nav = performance.getEntriesByType?.("navigation")?.[0];
        const type = nav && nav.type ? nav.type : "";
        const isReload = type === "reload";

        const hasHash = !!location.hash && location.hash !== "#top";
        const shouldReset = !hasHash;

        const toTop = () => {
          // hard reset both axes (fixes “mysterious left drift”)
          window.scrollTo(0, 0);
          requestAnimationFrame(() => window.scrollTo(0, 0));
          setTimeout(() => window.scrollTo(0, 0), 60);
        };

        if (shouldReset) {
          window.addEventListener("load", toTop, { once: true });
          window.addEventListener("pageshow", (e) => {
            if (e.persisted) toTop();
          });
        } else if (isReload) {
          // reload with hash: keep hash behavior
        }
      })();
    </script>

    <!-- Global CTA -> #contact: smooth scroll + focus first field + glow sweep -->
    <script>
      (() => {
        const reduced =
          window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

        const isContactLink = (a) => {
          try {
            const u = new URL(a.getAttribute("href") || a.href || "", location.href);
            return u.hash === "#contact";
          } catch {
            return (a.getAttribute("href") || "") === "#contact";
          }
        };

        const highlight = () => {
          const frame =
            document.querySelector("#contact [data-contact-frame]") ||
            document.querySelector("#contact .k-contact2__frame");
          if (!frame) return;

          frame.classList.remove("is-highlight");
          void frame.offsetWidth;
          frame.classList.add("is-highlight");
          setTimeout(() => frame.classList.remove("is-highlight"), 900);
        };

        const focusFirst = () => {
          const first =
            document.querySelector("#contact [data-first-field]") ||
            document.querySelector(
              "#contact input, #contact textarea, #contact select, #contact button"
            );
          if (!first) return;
          try {
            first.focus({ preventScroll: true });
          } catch {
            first.focus();
          }
        };

        const scrollToContact = () => {
          const target = document.querySelector("#contact");
          if (!target) return;

          // nuke any horizontal offset first
          window.scrollTo({ left: 0, top: window.scrollY, behavior: "auto" });

          if (location.hash !== "#contact") {
            history.pushState(null, "", "#contact");
          }

          target.scrollIntoView({
            behavior: reduced ? "auto" : "smooth",
            block: "start",
            inline: "nearest", // IMPORTANT: never scroll sideways
          });

          const start = performance.now();
          const tick = () => {
            const r = target.getBoundingClientRect();
            const done = r.top < 140 && r.top > -80;
            if (done || performance.now() - start > 900) {
              highlight();
              setTimeout(focusFirst, reduced ? 0 : 60);
              return;
            }
            requestAnimationFrame(tick);
          };
          requestAnimationFrame(tick);
        };

        document.addEventListener(
          "click",
          (e) => {
            const a = e.target && e.target.closest ? e.target.closest("a") : null;
            if (!a) return;
            if (!isContactLink(a)) return;

            e.preventDefault();
            scrollToContact();
          },
          { passive: false }
        );
      })();
    </script>
  </body>
</html>
